require_relative '../test_helper'
require 'webmock/test_unit'

class FinancialTest < Test::Unit::TestCase

  TESTING_ENDPOINT = 'http://example-dstu2-server.com'

  def test_connectathon_9_financial_requests
  # stub_request(:post, "http://example-dstu2-server.com/Claim").
  #   with(:body => "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Claim\n xmlns=\"http://hl7.org/fhir\">\n    <type value=\"oral\"/>\n    <created value=\"2015-04-16\"/>\n<target\n>\n    <reference value=\"Organization/654123\"/>\n</target>\n<organization\n>\n    <reference value=\"Organization/1535\"/>\n</organization>\n    <use value=\"complete\"/>\n<priority\n>\n    <code value=\"normal\"/>\n</priority>\n    <payee\n>\n<type\n>\n    <code value=\"provider\"/>\n</type>\n</payee>\n    <diagnosis\n>\n    <sequence value=\"1\"/>\n<diagnosis\n>\n    <code value=\"123456\"/>\n</diagnosis>\n</diagnosis>\n<patient\n>\n    <reference value=\"Patient/1\"/>\n</patient>\n    <coverage\n>\n    <sequence value=\"1\"/>\n    <focal value=\"true\"/>\n<coverage\n>\n    <reference value=\"Coverage/9876B1\"/>\n</coverage>\n<relationship\n>\n    <code value=\"self\"/>\n</relationship>\n</coverage>\n    <item\n>\n    <sequence value=\"1\"/>\n<type\n>\n    <code value=\"service\"/>\n</type>\n<provider\n>\n    <reference value=\"Practitioner/1\"/>\n</provider>\n<service\n>\n    <code value=\"1201\"/>\n</service>\n    <serviceDate value=\"2015-04-16\"/>\n<unitPrice\n>\n    <value value=\"135.57\"/>\n    <system value=\"urn:std:iso:4217\"/>\n    <code value=\"USD\"/>\n</unitPrice>\n<net\n>\n    <value value=\"135.57\"/>\n    <system value=\"urn:std:iso:4217\"/>\n    <code value=\"USD\"/>\n</net>\n</item>\n</Claim>\n",
  #   :headers => {'Accept'=>'application/xml+fhir', 'Accept-Charset'=>'UTF-8', 'Accept-Encoding'=>'gzip, deflate', 'Content-Length'=>'1259', 'Content-Type'=>'application/xml+fhir;charset=UTF-8', 'Resource'=>'FHIR::Claim', 'User-Agent'=>'Ruby FHIR Client'}).
  #   to_return(:status => 200, :body => "", :headers => {})

    stub_request(:post, "#{TESTING_ENDPOINT}/Claim").
      with(:body => "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Claim\n xmlns=\"http://hl7.org/fhir\">\n    <type value=\"oral\"/>\n    <created value=\"2015-04-16\"/>\n<target\n>\n    <reference value=\"Organization/654123\"/>\n</target>\n<organization\n>\n    <reference value=\"Organization/1535\"/>\n</organization>\n    <use value=\"complete\"/>\n<priority\n>\n    <code value=\"normal\"/>\n</priority>\n    <payee\n>\n<type\n>\n    <code value=\"provider\"/>\n</type>\n</payee>\n    <diagnosis\n>\n    <sequence value=\"1\"/>\n<diagnosis\n>\n    <code value=\"123456\"/>\n</diagnosis>\n</diagnosis>\n<patient\n>\n    <reference value=\"Patient/1\"/>\n</patient>\n    <coverage\n>\n    <sequence value=\"1\"/>\n    <focal value=\"true\"/>\n<coverage\n>\n    <reference value=\"Coverage/9876B1\"/>\n</coverage>\n<relationship\n>\n    <code value=\"self\"/>\n</relationship>\n</coverage>\n    <item\n>\n    <sequence value=\"1\"/>\n<type\n>\n    <code value=\"service\"/>\n</type>\n<provider\n>\n    <reference value=\"Practitioner/1\"/>\n</provider>\n<service\n>\n    <code value=\"1201\"/>\n</service>\n    <serviceDate value=\"2015-04-16\"/>\n<unitPrice\n>\n    <value value=\"135.57\"/>\n    <system value=\"urn:std:iso:4217\"/>\n    <code value=\"USD\"/>\n</unitPrice>\n<net\n>\n    <value value=\"135.57\"/>\n    <system value=\"urn:std:iso:4217\"/>\n    <code value=\"USD\"/>\n</net>\n</item>\n</Claim>\n",
      :headers => {'Accept'=>'application/xml+fhir', 'Accept-Charset'=>'UTF-8', 'Accept-Encoding'=>'gzip, deflate', 'Content-Length'=>'1259', 'Content-Type'=>'application/xml+fhir;charset=UTF-8', 'Resource'=>'FHIR::Claim', 'User-Agent'=>'Ruby FHIR Client'}).
      to_return(:status => 200, :body => "", :headers => {'Content-Type'=>'application/xml+fhir;charset=UTF-8', 'Last-Modified' => Time.now.httpdate, 'Content-Location' => "#{TESTING_ENDPOINT}/Claim/100150"})

    stub_request(:post, "#{TESTING_ENDPOINT}/Claim").
      with(:body => "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Claim\n xmlns=\"http://hl7.org/fhir\">\n    <type value=\"oral\"/>\n    <created value=\"2014-08-16\"/>\n<target\n>\n    <reference value=\"Organization/2\"/>\n</target>\n<organization\n>\n    <reference value=\"Organization/1\"/>\n</organization>\n    <use value=\"complete\"/>\n<priority\n>\n    <code value=\"normal\"/>\n</priority>\n    <payee\n>\n<type\n>\n    <code value=\"provider\"/>\n</type>\n</payee>\n    <diagnosis\n>\n    <sequence value=\"1\"/>\n<diagnosis\n>\n    <code value=\"123456\"/>\n</diagnosis>\n</diagnosis>\n<patient\n>\n    <reference value=\"Patient/1\"/>\n</patient>\n    <coverage\n>\n    <sequence value=\"1\"/>\n    <focal value=\"true\"/>\n<coverage\n>\n    <reference value=\"Coverage/9876B1\"/>\n</coverage>\n<relationship\n>\n    <code value=\"self\"/>\n</relationship>\n</coverage>\n    <item\n>\n    <sequence value=\"1\"/>\n<type\n>\n    <code value=\"service\"/>\n</type>\n<provider\n>\n    <reference value=\"Practitioner/1\"/>\n</provider>\n<service\n>\n    <system value=\"http://hl7.org/fhir/oralservicecodes\"/>\n    <code value=\"1200\"/>\n</service>\n    <serviceDate value=\"2014-08-16\"/>\n<unitPrice\n>\n    <value value=\"135.57\"/>\n    <system value=\"urn:std:iso:4217\"/>\n    <code value=\"USD\"/>\n</unitPrice>\n<net\n>\n    <value value=\"135.57\"/>\n    <system value=\"urn:std:iso:4217\"/>\n    <code value=\"USD\"/>\n</net>\n</item>\n<item\n>\n    <sequence value=\"2\"/>\n<type\n>\n    <code value=\"service\"/>\n</type>\n<provider\n>\n    <reference value=\"Practitioner/1\"/>\n</provider>\n<service\n>\n    <system value=\"http://hl7.org/fhir/oralservicecodes\"/>\n    <code value=\"21211\"/>\n</service>\n    <serviceDate value=\"2014-08-16\"/>\n<unitPrice\n>\n    <value value=\"105.0\"/>\n    <system value=\"urn:std:iso:4217\"/>\n    <code value=\"USD\"/>\n</unitPrice>\n<net\n>\n    <value value=\"105.0\"/>\n    <system value=\"urn:std:iso:4217\"/>\n    <code value=\"USD\"/>\n</net>\n<bodySite\n>\n    <system value=\"http://fdi.org/fhir/oraltoothcodes\"/>\n    <code value=\"21\"/>\n</bodySite>\n<subSite\n>\n    <system value=\"http://fdi.org/fhir/oralsurfacecodes\"/>\n    <code value=\"L\"/>\n</subSite>\n</item>\n<item\n>\n    <sequence value=\"3\"/>\n<type\n>\n    <code value=\"group\"/>\n</type>\n<provider\n>\n    <reference value=\"Practitioner/1\"/>\n</provider>\n<service\n>\n    <system value=\"http://hl7.org/fhir/oralservicecodes\"/>\n    <code value=\"27211\"/>\n</service>\n    <serviceDate value=\"2014-08-16\"/>\n<unitPrice\n>\n    <value value=\"1100.0\"/>\n    <system value=\"urn:std:iso:4217\"/>\n    <code value=\"USD\"/>\n</unitPrice>\n<net\n>\n    <value value=\"1100.0\"/>\n    <system value=\"urn:std:iso:4217\"/>\n    <code value=\"USD\"/>\n</net>\n<bodySite\n>\n    <system value=\"http://fdi.org/fhir/oraltoothcodes\"/>\n    <code value=\"36\"/>\n</bodySite>\n    <detail\n>\n    <sequence value=\"1\"/>\n<type\n>\n    <code value=\"service\"/>\n</type>\n<service\n>\n    <system value=\"http://hl7.org/fhir/oralservicecodes\"/>\n    <code value=\"27211\"/>\n</service>\n<unitPrice\n>\n    <value value=\"750.0\"/>\n    <system value=\"urn:std:iso:4217\"/>\n    <code value=\"USD\"/>\n</unitPrice>\n<net\n>\n    <value value=\"750.0\"/>\n    <system value=\"urn:std:iso:4217\"/>\n    <code value=\"USD\"/>\n</net>\n</detail>\n<detail\n>\n    <sequence value=\"2\"/>\n<type\n>\n    <code value=\"service\"/>\n</type>\n<service\n>\n    <system value=\"http://hl7.org/fhir/oralservicecodes\"/>\n    <code value=\"lab\"/>\n</service>\n<unitPrice\n>\n    <value value=\"350.0\"/>\n    <system value=\"urn:std:iso:4217\"/>\n    <code value=\"USD\"/>\n</unitPrice>\n<net\n>\n    <value value=\"350.0\"/>\n    <system value=\"urn:std:iso:4217\"/>\n    <code value=\"USD\"/>\n</net>\n</detail>\n</item>\n</Claim>\n",
      :headers => {'Accept'=>'application/xml+fhir', 'Accept-Charset'=>'UTF-8', 'Accept-Encoding'=>'gzip, deflate', 'Content-Length'=>'3487', 'Content-Type'=>'application/xml+fhir;charset=UTF-8', 'Resource'=>'FHIR::Claim', 'User-Agent'=>'Ruby FHIR Client'}).
      to_return(:status => 200, :body => "", :headers => {'Content-Type'=>'application/xml+fhir;charset=UTF-8', 'Last-Modified' => Time.now.httpdate, 'Content-Location' => "#{TESTING_ENDPOINT}/Claim/100151"})

    stub_request(:delete, "#{TESTING_ENDPOINT}/Claim/100150").
      with(:headers => {'Accept'=>'application/xml+fhir', 'Accept-Charset'=>'UTF-8', 'Accept-Encoding'=>'gzip, deflate', 'Format'=>'application/xml+fhir', 'Id'=>'100150', 'Resource'=>'FHIR::Claim', 'User-Agent'=>'Ruby FHIR Client'}).
      to_return(:status => 200, :body => "", :headers => {})

    stub_request(:delete, "#{TESTING_ENDPOINT}/Claim/100151").
      with(:headers => {'Accept'=>'application/xml+fhir', 'Accept-Charset'=>'UTF-8', 'Accept-Encoding'=>'gzip, deflate', 'Format'=>'application/xml+fhir', 'Id'=>'100151', 'Resource'=>'FHIR::Claim', 'User-Agent'=>'Ruby FHIR Client'}).
      to_return(:status => 200, :body => "", :headers => {})

    client = FHIR::Client.new(TESTING_ENDPOINT)
    financial = Crucible::Tests::ConnectathonFinancialTrackTest.new(client)
    financial.tests_subset = financial.tests(['C9F_1A', 'C9F_1B'])
    results = financial.execute_test_methods

    assert !results.blank?, 'Failed to execute ConnectathonFinancialTrackTest.'
    assert results.map {|r| r["status"] }.all? {|s| s=="pass"}, "FinacialTest methods did execute succesfully: #{results.map {|r| {r["id"] => r["status"]}}}}."
  end

end
